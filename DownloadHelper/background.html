<html>
<head>
<script>
var TEMP;


function scanTF()//scan Thunder/Flashget is enabled
{
	localStorage.thunder = pluginobj.thunderIsEnabled();
	localStorage.flashget = pluginobj.flashgetIsEnabled();
	if(localStorage.defDown) {

	}
	else {
		if(eval(localStorage.thunder)) {
			localStorage.defDown = "thunder";
		}
		else if(eval(localStorage.flashget)) {
			localStorage.defDown = "flashget";
		}
	}
}
function init()
{
	chrome.tabs.onSelectionChanged.addListener(function(tabId) {
		var js = 'chrome.tabs.executeScript(' + tabId + ', {file: "npdownload.js"});';
		//js += 'chrome.tabs.executeScript(' + tabId + ', {code: "init();"});';
		chrome.tabs.sendRequest(tabId, "check", function(response) {
			if(response) {//check Content-Script is loaded
				//js = "";
				js = 'chrome.tabs.executeScript(' + tabId + ', {code: "alert(123);"});';
			}
		});
		//setTimeout("eval('" + js + "');", 1500);
		var timeout = 0;
		while(timeout<1) {
			setTimeout(function(timeout){timeout++;},1000);
		}
		eval(js);
		//chrome.tabs.executeScript(tabId, {code: 'defDown="' + localStorage.defDown + '";'});
	});
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
		if(request.command == "defDown") {
			sendResponse(localStorage.defDown);
		}
		switch(localStorage.defDown) {
			case "flashget":
				sendResponse(true);
				pluginobj.flashgetAddLink(request.content[0],
						request.content[1], request.content[2]);
				break;
			case "thunder":
				sendResponse(true);
				pluginobj.thunderAddLink(request.content[0],
						request.content[1], request.content[2]);
				break;
			default:
				sendResponse(false);
		}
	});
	chrome.extension.onConnect.addListener(function(port) {
		port.onMessage.addListener(function(message) {
			if (message)
			{
				switch (message.command)
				{
					case 'ThunderStart':
						TEMP = '';
						break;
					case 'ThunderAdd':
						TEMP += '"' + message.content[0] + '","' + message.content[1] + '",';
						break;
					case 'ThunderEnd':
						TEMP = 'pluginobj.thunderDownloadAll("' + message.content[2] + '",' + TEMP + '0)';
						eval(TEMP);
						break;
					case 'ThunderCommit':
						//pluginobj.thunderCommit();
						break;
					
					case 'FlashgetStart':
						TEMP = '';
						break;
					case 'FlashgetAdd':
						TEMP += '"' + message.content[0] + '","' + message.content[1] + '",';
						break;
					case 'FlashgetEnd':
						TEMP = 'pluginobj.flashgetDownloadAll("' + message.content[2] + '",' + TEMP + '0)';
						eval(TEMP);
						break;
					case 'FlashgetCommit':
						//pluginobj.flashgetCommit();
						break;
				}
			}
		});
	});
	scanTF();
}
</script>
</head>
<body onload="init()">
<object id="pluginobj" type="application/x-downloadhelper" hidden="true">
Failed to load np plugin. You might be using the old version of the extension.</object>
</body>
</html>
