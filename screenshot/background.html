<html>
<head>
<script>

var screenshot = {
	tabid:0,
	data:'',
	canvas:'',
	visibleHeight:0,
	visibleWidth:0,
	i:0,
	j:0,

	messageHandler: function() {
		chrome.extension.onConnect.addListener(function(port) {
			port.onMessage.addListener(function(obj) {
				switch(obj.msg) {
					case "capture_window":
						screenshot.capturePortion(0, 0, obj.width, obj.height);
						break;
					case "capture_selected":
						screenshot.capturePortion(obj.x, obj.y, obj.width, obj.height);
						break;
					case "save":
						screenshot.postImage();
						break;
					case "scroll_init_done":
						screenshot.canvas = document.createElement('canvas');
						screenshot.canvas.width = obj.width;
						screenshot.canvas.height = obj.height;
						screenshot.visibleHeight = obj.visibleHeight;
						screenshot.visibleWidth = obj.visibleWidth;
						screenshot.i = obj.i;
						screenshot.j = obj.j;
						
					case "scroll_next_done":
						screenshot.i = obj.i;
						screenshot.j = obj.j;
						screenshot.captureToCanvas();
						break;
					case "scroll_finished":
						screenshot.captureToCanvasDone();
						break;
				}
			});
		});
	},

	captureVisible: function() {
		chrome.tabs.getSelected(null, function(tab) {
			screenshot.tabid = tab.id;
			screenshot.sendMessage("capture_visible");
		});
	},

	captureEntire: function() {
		chrome.tabs.getSelected(null, function(tab) {
			screenshot.tabid = tab.id;
			screenshot.sendMessage("scroll_init");
		});
	},

	showArea: function() {
		chrome.tabs.getSelected(null, function(tab) {
			screenshot.tabid = tab.id;
			screenshot.sendMessage("show_area");
		});
	},

	capturePortion: function(x, y, width, height) {
		chrome.tabs.captureVisibleTab(null, function(data) {
			var image = new Image();
			image.onload = function()
			{
				var canvas = document.createElement('canvas');
				canvas.width = width;
				canvas.height = height;
				
				var ctx = canvas.getContext("2d");
				ctx.drawImage(image, x, y, width, height, 0, 0, width, height);
				screenshot.data = canvas.toDataURL("image/png");

				screenshot.sendMessage("post_image");
			};
			image.src = data;
		});
	},

	captureToCanvas: function() {
		chrome.tabs.captureVisibleTab(null, function(data) {
			var image = new Image();
			image.onload = function()
			{
				var ctx = screenshot.canvas.getContext("2d");
				var width = 0;
				var height = 0;
				var x1 = 0;
				var x2 = 0;
				var y1 = 0;
				var y2 = 0;
				if((screenshot.j+1)*screenshot.visibleWidth > screenshot.canvas.width) {
					width = screenshot.canvas.width % screenshot.visibleWidth ;
					x1 = (screenshot.j+1)*screenshot.visibleWidth - screenshot.canvas.width ;
			
				}
				else {
					width = screenshot.visibleWidth ;
				}
				if((screenshot.i + 1)*screenshot.visibleHeight > screenshot.canvas.height) {
					height = screenshot.canvas.height % screenshot.visibleHeight;
					y1 = (screenshot.i+1)*screenshot.visibleHeight - screenshot.canvas.height;
				}
				else {
					height = screenshot.visibleHeight ;
				}
				x2 = screenshot.j*screenshot.visibleWidth ;
				y2 = screenshot.i*screenshot.visibleHeight ;

				ctx.drawImage(image, x1, y1, width, height, x2, y2, width, height);
				
				
				screenshot.sendMessage("scroll_next");
			};
			image.src = data;
		});
	},

	captureToCanvasDone: function() {
		screenshot.data = screenshot.canvas.toDataURL("image/png");
		screenshot.sendMessage("post_image");
	},

	sendMessage: function(message) {
		chrome.tabs.sendRequest(screenshot.tabid, {msg: message}, function() {});
	},

	postImage: function() {
		chrome.tabs.create({'url':'showimage.html'},function(newTab) {
			var port = chrome.tabs.connect(newTab.id,{name:"imgData"});
			port.postMessage({imgData:screenshot.data})
		});
	}
	
};

screenshot.messageHandler();

chrome.tabs.onSelectionChanged.addListener(function(tabid) {
	chrome.tabs.executeScript(tabid, {file:'dragdrop.js'});	
});

</script>
</head>
</html>
